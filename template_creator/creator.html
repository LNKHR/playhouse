<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="shortcut icon" type="image/png" href="favicon.png" />
  <title>Toyhou.se Template Editor</title>

  <!-- Toyhou.se Theme -->
  <link href="../styles/toyhouse_themes/night.css" title="thThemes" id="thThemes" rel="stylesheet" type="text/css" />
  <link href="../styles/global.css" rel="stylesheet" type="text/css" />

</head>
<body id="main">
  
  <div class="clearfix container-fluid p-0">
    <div class="row no-gutters flex-nowrap">

      <div class="bg-faded" id="codeEditor">
        <div class="main-editor">
          <div class="row flex-nowrap no-gutters p-1 align-items-center options">

            <!-- Documentation -->
            <div class="col-auto p-1">
              <button class="btn btn-default d-block" title="Documentation" data-toggle="tooltip" data-placement="bottom"><i class="fas fa-book"></i></button>
            </div>

            <!-- Editor Theme Change -->
            <div class="col-auto p-1">
              <button class="btn btn-default d-block" title="Editor Theme" data-toggle="tooltip" data-placement="bottom" onclick="editorThemeToggle()"><i class="fas fa-sun"></i></button>
            </div>

            <!-- Copy -->
            <div class="col-auto p-1 hidden-sm-down">
              <button class="btn btn-default d-block" title="Toggle Sidebar" data-toggle="tooltip"
                data-placement="bottom" onclick="sidebarToggle()"><i class="fas fa-adjust"></i></button>
            </div>

            <!-- Theme Options -->
            <div class="col p-1">
              <form>
                <select class="form-control" id="thCSSThemes">
                  <option selected value="styles/toyhouse_themes/night.css">Night</option>
                  <option value="styles/toyhouse_themes/default.css">Default</option>
                  <option value="styles/toyhouse_themes/pink.css">Pink</option>
                  <option value="styles/toyhouse_themes/teal.css">Teal</option>
                  <option value="styles/toyhouse_themes/bee.css">Bee</option>
                  <option value="styles/toyhouse_themes/velvet.css">Velvet</option>
                </select>
              </form>
            </div>

            <!-- Render -->
            <div class="col-auto p-1">
              <button class="btn btn-primary d-block" title="Create Form" data-toggle="tooltip" data-placement="bottom" id="render-form">
                <i class="fas fa-pen-to-square"></i>
              </button>
            </div>

          </div>
          <textarea id="html"></textarea>
        </div>
        <div class="resizer-horizontal bg-secondary"><i class="fas fa-grip-lines"></i></div>
        <div class="written-html">
          <textarea id="writtenhtml"></textarea>
        </div>
        <div class="resizer-horizontal-2 bg-secondary"><i class="fas fa-grip-lines"></i></div>
        <div class="p-4" id="options"></div>
      </div>
      <div class="resizer bg-secondary hidden-sm-down"><i class="fas fa-grip-lines-vertical"></i></div>

      <!-- Render Area -->
      <div class="col" style="overflow: hidden !important;">

        <!-- Navbar -->
        <nav class="navbar navbar-toggleable-sm navbar-inverse header" data-topbar="" role="navigation" id="header">
          <a class="navbar-brand" href="index.html">TOYHOU.SE</a>
        </nav>

        <!-- Mobile Menu -->
        <div class="hidden-md-up nav-mobile-menu">
          <button class="btn btn-outline-secondary nav-mobile-menu-toggle" onclick="offCanvas()" data-target="#">
            Menu <span class="fa fa-caret-right"></span>
          </button>
        </div>

        <!-- Main Content -->
        <div id="main" class="clearfix container-fluid">
          <div class="row" style="min-height: calc(100vh - 55px)"> 
            
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar hidden-md-down" id="sidebar">
              <ul class="side-nav list-unstyled">
                <li class="header"><i class="fas fa-user header-icon"></i>User</li>
                <li>
                  <span class="display-user">
                    <a href="">
                      <img src="favicon.png" class="display-user-avatar">
                      <span class="display-user-username">user</span>
                    </a>
                  </span>
                </li>
                <li class="divider sidebar-divider-username"></li>
                <li class=" sidebar-li-bulletins"><a href=""><i class="far fa-newspaper fa-fw sidebar-icon"></i>Bulletins</a></li>
                <li class=" sidebar-li-characters"><a href=""><i class="fa fa-users fa-fw sidebar-icon"></i>Characters</a></li>
                <li class=" sidebar-li-links"><a href=""><i class="fa fa-link fa-fw sidebar-icon"></i>Links</a></li>
                <li class=" sidebar-li-worlds"><a href=""><i class="fa fa-globe fa-fw sidebar-icon"></i>Worlds</a></li>
                <li class=" sidebar-li-favorites"><a href=""><i class="fa fa-star fa-fw sidebar-icon"></i>Favorites</a></li>
                <li class="divider sidebar-divider-collections"></li>
                <li class=" sidebar-li-created"><a href=""><i class="fa fa-palette fa-fw sidebar-icon"></i>Designs</a></li>
                <li class=" sidebar-li-art"><a href=""><i class="fa fa-paint-brush fa-fw sidebar-icon"></i>Art</a></li>
                <li class=" sidebar-li-literatures"><a href=""><i class="fa fa-book fa-fw sidebar-icon"></i>Library</a></li>
                <li class="divider sidebar-divider-stats"></li>
                <li class=" sidebar-li-stats"><a href=""><i class="fa fa-chart-bar fa-fw sidebar-icon"></i>Stats</a>
                </li>
              </ul>
            </div>

            <!-- Main Content -->
            <div class="col-sm-12 col-md-9 col-lg-10 content-main" id="content">
              <div class="row">
                <div class="col-lg-12">
                  <div class="profile-section profile-content-section user-content fr-view">
                    <div class="" id="code"></div>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- Footer -->
        <div class="text-muted text-center p-3 footer">
          This is a live compiler for Toyhou.se HTML Layouts!<br>
          <a class="mx-2" href="https://toyhou.se/">Toyhou.se</a>
          <a class="mx-2" href="https://toyhou.se/~messages/create/cheerikola">Report a Bug</a>
          <a class="mx-2" href="https://ko-fi.com/cheeriko">Support Me</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

  <!-- Resizer -->
  <script type="text/javascript" src="https://rawgit.com/RickStrahl/jquery-resizable/master/src/jquery-resizable.js"></script>

  <!-- Font Awesome -->
  <script src="https://kit.fontawesome.com/734cc6a413.js" crossorigin="anonymous"></script>

  <!-- Ace Editor -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.9/ace.js"></script>

  <!-- Dah JS -->
  <script src="main.js" type="text/javascript"></script>
  <script type="text/javascript">
    

    /* Compile HTML 
    ========================================================== */
    editor.addEventListener('change', function () {
      let code = document.getElementById("code");
      const text = editor.getValue();
      localStorage.setItem("htmluser", text);
      code.innerHTML = text;
      // writtenEdit.setValue(text);
    });

    // Loads user's previous html into the editor
    window.onload = () => {
      const savedText = localStorage.getItem("htmluser") || "";
      code.innerHTML = savedText;
      editor.session.setValue(savedText);
    };

    // Grabs user input from the forms
    function inputGetter() {
      var inputs = document.querySelectorAll('.user-input');    
      var inputArray = [];
      for (var i = 0; i < inputs.length; i++) {
        inputArray[i] = {
          id: inputs[i].id,
          value: inputs[i].value
        };        
      }
      console.log(inputs);
      return inputArray;
    }

    // Grabs the template and makes it look nice and neat
    function templateGetter() {

      // Grabbing all dah HTML
      var savedInput = inputGetter();
      var itemList = editor.getValue().match(/{{(?:.+)}}/gm); //.filter((x, i, a) => a.indexOf(x) == i)
      let cleanList = [];
      let bigArray = [];
      
      for (let i = 0; i < itemList.length; i++) {

        // So we don't have to keep scrubbing the {{}}
        cleanList.push(itemList[i].split('{{')[1].split('}}')[0]);

        // Removes undefined from value
        let itemValues = (cleanList[i].split(/:(.+)/)[1].split('|')[1] == undefined) ? "[info]" : cleanList[i].split(/:(.+)/)[1].split('|')[1];

        // Makes a pretty array of info
        bigArray[i] = {
          itemList: cleanList[i],
          itemInput: cleanList[i].split(':')[0],
          itemTitle: cleanList[i].split(':')[1].split('|')[0],
          itemID: cleanList[i].replace(/\s/g, '-').split(':')[1].split('|')[0],
          itemValue: itemValues
        };
        
        // Saved user input
        if (savedInput.length > 0) {
          for(let j = 0; j < savedInput.length; j++){
            if(savedInput[j].id == bigArray[i].itemID) {
              bigArray[i].itemValue = savedInput[j].value;
            }
          }
        } 
        
      };

      return bigArray;
      
    }


    function insertInput() {
      //get the original template
      var inputChange = editor.getValue();
      var inputArray = inputGetter();
      var bigArray = templateGetter();

      //loop through big array to store user input then change html using template accordingly
      for (var i = 0; i < bigArray.length; i++) {
        for (var j = 0; j < inputArray.length; j++) {
          if(inputArray[j].id == bigArray[i].itemID){    

            // only one of these works at a time lol
            if(bigArray[i].itemInput == 'textarea') {
              bigArray[i].userInput = "<p>" + inputArray[j].value.replaceAll("\n",`</p>
              <p>`) + "</p>";
            } else if(bigArray[i].itemInput == 'list') {
              bigArray[i].userInput = "<li>" + inputArray[j].value.replaceAll("\n",`</li>
              <li>`) + "</li>";
            } else {
              bigArray[i].userInput = inputArray[j].value;
            }  

            // only replaces the first instance of the item
            var inputChange = inputChange.replace(`{{${bigArray[i].itemList}}}`,`${bigArray[i].userInput}`);
            code.innerHTML = inputChange;
            writtenEdit.setValue(inputChange);

          }
        }    
      }
    };

    
    let bigArray = [];
    
    document.getElementById('render-form').addEventListener('click', function () {
      var bigArray = templateGetter();
      document.getElementById('options').innerHTML = "";

      // Creates the forms
      for (let i = 0; i < bigArray.length; i++) {

        let inputText = `
          <label for="${bigArray[i].itemID}">${bigArray[i].itemTitle}</label>
          <input class="form-control user-input" type="text" value="${bigArray[i].itemValue}" input-type="${bigArray[i].itemInput}" name="${bigArray[i].itemID}" id="${bigArray[i].itemID}"></input>
          <hr class="mx-n4">
        `;

        let inputTextArea = `
          <label for="${bigArray[i].itemID}">${bigArray[i].itemTitle}</label>
          <textarea class="form-control user-input" type="color" input-type="${bigArray[i].itemInput}" name="${bigArray[i].itemID}" id="${bigArray[i].itemID}">${bigArray[i].itemValue}</textarea>
          <hr class="mx-n4">
        `;

        let inputColor = `
          <label for="${bigArray[i].itemID}">${bigArray[i].itemTitle}</label>
          <input class="form-control user-input" value="${bigArray[i].itemValue}" type="color" input-type="${bigArray[i].itemInput}" name="${bigArray[i].itemID}" id="${bigArray[i].itemID}"></input>
          <hr class="mx-n4">
        `;

        let inputNumber = `
          <label for="${bigArray[i].itemID}">${bigArray[i].itemTitle}</label>
          <input class="form-control user-input" value="${bigArray[i].itemValue}" type="number" input-type="${bigArray[i].itemInput}" name="${bigArray[i].itemID}" id="${bigArray[i].itemID}"></input>
          <hr class="mx-n4">
        `;

        let inputBootstrap = `
          <label for="${bigArray[i].itemID}">${bigArray[i].itemTitle}</label>
          <select class="form-control user-input" input-type="${bigArray[i].itemInput}" name="${bigArray[i].itemID}" id="${bigArray[i].itemID}">
            <option value="primary">Primary</option>
            <option value="warning">Warning</option>
            <option value="info">Info</option>
            <option value="danger">Danger</option>
          </select> 
          <hr class="mx-n4">
        `;

        let inputList = `
          <label for="${bigArray[i].itemID}">${bigArray[i].itemTitle}</label>
          <textarea class="form-control user-input" type="color" input-type="${bigArray[i].itemInput}" name="${bigArray[i].itemID}" id="${bigArray[i].itemID}"></textarea>
          <hr class="mx-n4">
        `;

        

        if (bigArray[i].itemInput == "text") {
          document.getElementById('options').innerHTML += inputText;
        } if (bigArray[i].itemInput == "textarea") {
          document.getElementById('options').innerHTML += inputTextArea;
        } if (bigArray[i].itemInput == "color") {
          document.getElementById('options').innerHTML += inputColor;
        } if (bigArray[i].itemInput == "number") {
          document.getElementById('options').innerHTML += inputNumber;
        } if (bigArray[i].itemInput == "bootstrap") {
          document.getElementById('options').innerHTML += inputBootstrap;
        } if (bigArray[i].itemInput == "list") {
          document.getElementById('options').innerHTML += inputList;
        }

      }

      insertInput();

    }); 
    
        

    document.querySelector("#options").addEventListener("change",function() {
      insertInput();
    });
      

        

  </script>

</body>
</html>